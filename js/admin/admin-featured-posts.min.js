jQuery(document).ready(function(i){"use strict";var t=Object.create(window.ikiToolkit.admin.SearchPosts),e=i("#iki-search-posts-wrap");t.init({postType:e.data("ikiType"),optionName:e.data("ikiOptionName"),ajaxNonce:i("#iki-ajax-nonce").data("ikiNonce"),$searchField:i("#iki-search-post"),$addBtn:i("#iki-add-post"),$foundContainer:i("#iki-found-posts"),$selectedContainer:i("#iki-selected-posts"),$spinner:i("#iki-spinner"),$postsNotFound:i("#iki-posts-not-found"),$postsError:i("#iki-posts-error")})}),window.ikiToolkit=window.ikiToolkit||{},window.ikiToolkit.admin=window.ikiToolkit.admin||{},window.ikiToolkit.admin.SearchPosts=function(i){function t(t){var e=this;this.compiledResult=_.template('<span class="iki-post-result"><label><input data-iki-title="<%=title%>" data-iki-id="<%=id%>" data-iki-link="<%=link%>" type="checkbox"><%= title %></label></span>'),this.compileSelected=_.template('<div class="iki-title-wrap iki-dynamic" data-iki-id="<%=id%>"><span class="content button iki-remove-post">X</span><p class="iki-post-title"><a href="<%=link%>" target="_blank"><%=title%></a></p><input type="hidden" name="<%=optionName%>[posts][<%=id%>]" value="<%=id%>" /></div>'),this.postType=t.postType,this.optionName=t.optionName,this.$searchField=t.$searchField,this.$addBtn=t.$addBtn,this.$foundContainer=t.$foundContainer,this.$selectedContainer=t.$selectedContainer,this.$spinner=t.$spinner,this.ajaxNonce=t.ajaxNonce,this.url=ajaxurl,this.$postsError=t.$postsError,this.$postsNotFound=t.$postsNotFound,this.requestTimestamp=Date.now(),this.selectedPosts={};var s=this.$selectedContainer.children();s.length&&(e._sortList(),s.each(function(){e.selectedPosts[i(this).data("ikiId")]=!0})),this.removePost=function(t){t.preventDefault();var s=i(this);delete e.selectedPosts[s.parent().data("ikiId")],s.parent().remove()},this.$selectedContainer.find(".iki-remove-post").on("click",this.removePost),this.$addBtn.on("click",function(t){t.preventDefault();var s=e.$foundContainer.find("input").filter(function(){var t=i(this);return t.attr("checked")&&!e.selectedPosts[t.data("ikiId")]});if(s.length){var n="";s.each(function(){var t=i(this);e.selectedPosts[t.data("ikiId")]=!0,n+=e.compileSelected({id:t.data("ikiId"),title:t.data("ikiTitle"),link:t.data("ikiLink"),optionName:e.optionName})}),n=i(n),e.$selectedContainer.append(n),n.find(".iki-remove-post").on("click",e.removePost)}}),this.debouncedRequest=_.debounce(this._sendRequest,500),this.$searchField.on("keyup",function(t){var s=i(this).val();e.debouncedRequest(s,_.bind(e._displayResults,e))})}function e(t,e){this.$spinner.css("visibility","visible"),this.$postsNotFound.addClass("hidden"),this.$postsError.addClass("hidden").find(".iki-server-error").empty(),i.ajax({type:"POST",url:this.url,dataType:"json",timeout:15e3,data:{search:t,_ajax_nonce:this.ajaxNonce,time:Date.now(),action:"iki_search_posts",post_type:this.postType}}).done(function(i,t,s){e(i,t,s)}).fail(function(i,t,s){e(i,t,s)})}function s(i,t,e){var s=this;if(this.$spinner.css("visibility","hidden"),this.$foundContainer.empty(),"success"===t&&i.time>s.requestTimestamp)if(s.requestTimestamp=i.time,i.posts.length){var n="";_.forEach(i.posts,function(i){n+=s.compiledResult({id:i.id,link:i.edit_post_link,title:i.title})}),s.$foundContainer.html(n),s._sortList()}else s.$postsNotFound.removeClass("hidden");else s.$postsError.removeClass("hidden").find(".iki-server-error").html(e)}function n(){this.$selectedContainer.sortable({revert:!0}).disableSelection(),this.$selectedContainer.find("li").disableSelection()}return{init:t,_displayResults:s,_sendRequest:e,_sortList:n}}(jQuery);